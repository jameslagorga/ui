<!DOCTYPE html>
<html>
<head>
    <title>Stream Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        #chart-container { width: 80%; margin: auto; }
    </style>
</head>
<body>
    <div id="chart-container">
        <canvas id="hand-count-chart"></canvas>
    </div>
    <div style="text-align: center; margin-top: 1em;">
        <label for="window-select">Time Window:</label>
        <select id="window-select">
            <option value="5m">5 Minutes</option>
            <option value="15m" selected>15 Minutes</option>
            <option value="1h">1 Hour</option>
            <option value="6h">6 Hours</option>
            <option value="24h">24 Hours</option>
        </select>
    </div>

    <script>
        const chartCanvas = document.getElementById('hand-count-chart');
        const windowSelect = document.getElementById('window-select');

        const path = window.location.pathname;
        const parts = path.split('/');
        const streamName = parts[parts.length - 2];
        document.title = `Monitoring: ${streamName}`;

        let handCountChart;

        // Function to format frame number into a zero-padded string
        function formatFrameNumber(n) {
            return String(n).padStart(8, '0');
        }

        async function fetchData() {
            const windowValue = windowSelect.value;
            const dataUrl = `/api/streams/${streamName}/frames?window=${windowValue}`;

            try {
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const chartData = data.map(point => ({
                    x: point[0], // Frame number
                    y: parseInt(point[1])
                }));

                if (handCountChart) {
                    handCountChart.data.labels = chartData.map(p => p.x);
                    handCountChart.data.datasets[0].data = chartData.map(p => p.y);
                    handCountChart.update();
                } else {
                    handCountChart = new Chart(chartCanvas, {
                        type: 'line',
                        data: {
                            labels: chartData.map(p => p.x),
                            datasets: [{
                                label: 'Hand Count',
                                data: chartData.map(p => p.y),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            onClick: (e) => {
                                const activePoints = handCountChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                                if (activePoints.length > 0) {
                                    const firstPoint = activePoints[0];
                                    const frameNumber = handCountChart.data.labels[firstPoint.index];
                                    const imageName = `frame_${formatFrameNumber(frameNumber)}.jpg`;
                                    const imageUrl = `http://34.11.233.133/streams/${streamName}/annotations/${imageName}`;
                                    window.open(imageUrl, '_blank');
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Frame Number'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Hand Count'
                                    }
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error fetching chart data:', error);
            }
        }

        windowSelect.addEventListener('change', fetchData);

        fetchData();
        setInterval(fetchData, 5000); // Refresh every 5 seconds
    </script>
</body>
</html>
