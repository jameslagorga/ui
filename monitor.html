<!DOCTYPE html>
<html>
<head>
    <title>Stream Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        #chart-container { width: 80%; margin: auto; }
    </style>
</head>
<body>
    <div id="chart-container">
        <canvas id="hand-count-chart"></canvas>
    </div>
    <div style="text-align: center; margin-top: 1em;">
        <label for="window-select">Time Window:</label>
        <select id="window-select">
            <option value="5m">5 Minutes</option>
            <option value="15m" selected>15 Minutes</option>
            <option value="1h">1 Hour</option>
            <option value="6h">6 Hours</option>
            <option value="24h">24 Hours</option>
        </select>
    </div>

    <script>
        const chartCanvas = document.getElementById('hand-count-chart').getContext('2d');
        const windowSelect = document.getElementById('window-select');

        const path = window.location.pathname;
        const parts = path.split('/');
        const streamName = parts[parts.length - 2];
        document.title = `Monitoring: ${streamName}`;

        let handCountChart;

        async function fetchData() {
            const windowValue = windowSelect.value;
            const dataUrl = `/api/streams/${streamName}/frames?window=${windowValue}`;

            try {
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const chartData = data.map(point => ({
                    x: new Date(point[0]),
                    y: parseInt(point[1])
                }));

                if (handCountChart) {
                    handCountChart.data.datasets[0].data = chartData;
                    handCountChart.update();
                } else {
                    handCountChart = new Chart(chartCanvas, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: 'Hand Count',
                                data: chartData,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'minute'
                                    }
                                },
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error fetching chart data:', error);
            }
        }

        windowSelect.addEventListener('change', fetchData);

        fetchData();
        setInterval(fetchData, 5000); // Refresh every 5 seconds
    </script>
</body>
</html>