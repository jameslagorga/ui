<!DOCTYPE html>
<html>
<head>
    <title>Stream Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; }
        #stream-info { position: absolute; top: 10px; left: 10px; font-size: 1.2em; }
        #image-container img { max-width: 200px; margin: 5px; }
    </style>
</head>
<body>
    <div id="stream-info">
        <b id="stream-name"></b>
    </div>
    <canvas id="result-distribution" width="400" height="200"></canvas>
    <hr>
    <h2>Annotated Images</h2>
    <div id="image-container"></div>

    <script>
        const streamNameElement = document.getElementById('stream-name');
        const resultCanvas = document.getElementById('result-distribution').getContext('2d');
        const imageContainer = document.getElementById('image-container');

        const path = window.location.pathname;
        const parts = path.split('/');
        const streamName = parts[2];
        streamNameElement.textContent = streamName;
        document.title = `Monitoring: ${streamName}`;

        const processedUrl = `http://34.11.233.133/streams/${streamName}/sample/processed/`;
        const annotationsUrl = `http://34.11.233.133/streams/${streamName}/annotations/`;

        let resultChart;

        async function fetchData() {
            // Fetch and display chart
            try {
                const response = await fetch(processedUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'));
                const files = links.map(a => a.getAttribute('href')).filter(href => href && href.endsWith('.json'));

                const results = [];
                for (const file of files) {
                    const fileResponse = await fetch(`${processedUrl}${file}`);
                    const data = await fileResponse.json();
                    results.push(data.result);
                }

                const resultCounts = {};
                results.forEach(result => {
                    resultCounts[result] = (resultCounts[result] || 0) + 1;
                });

                const resultLabels = Object.keys(resultCounts);
                const resultData = resultLabels.map(label => resultCounts[label]);

                if (resultChart) resultChart.destroy();

                resultChart = new Chart(resultCanvas, {
                    type: 'bar',
                    data: {
                        labels: resultLabels,
                        datasets: [{
                            label: 'Result Count',
                            data: resultData,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            } catch (error) {
                console.error(`Error fetching chart data: ${error}`);
            }

            // Fetch and display images
            try {
                const response = await fetch(annotationsUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'));
                const imageFiles = links.map(a => a.getAttribute('href')).filter(href => href && /\.(jpe?g|png|gif)$/i.test(href));

                imageContainer.innerHTML = ''; // Clear existing images
                for (const imageFile of imageFiles) {
                    const img = document.createElement('img');
                    img.src = `${annotationsUrl}${imageFile}`;
                    imageContainer.appendChild(img);
                }
            } catch (error) {
                console.error(`Error fetching images: ${error}`);
                imageContainer.innerHTML = 'Could not load images.';
            }
        }

        fetchData();
    </script>
</body>
</html>